[gd_scene load_steps=9 format=2]

[ext_resource path="res://ui/h_selector.gd" type="Script" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends Control

signal player_ready()

var controller : Globals.Player

func _ready():
	controller.focus = $Scroll/VBox.get_child(0)
	controller.connect(\"focus_changed\", self, \"_on_focus_changed\")
	
	# display controls
	$Scroll/VBox/Controls.text = (
		\"Move: \" + get_directional_input_name(0) + \"\\n\" +
		\"Tilt: \" + get_directional_input_name(1) + \"\\n\" +
		\"Jump/Dodge: \" + list_buttons(controller.button_settings.jump) + \"\\n\" +
		\"Weapon 1: \" + list_buttons(controller.button_settings.weapon_1) + \"\\n\" +
		\"Weapon 2: \" + list_buttons(controller.button_settings.weapon_2) + \"\\n\" +
		#\"Item: \" + list_buttons(controller.button_settings.item) + \"\\n\" +
		\"Guard [WIP]: \" + list_buttons(controller.button_settings.guard) + \"\\n\" +
		\"Throw: \" + list_buttons(controller.button_settings.throw))
	
	# color selection
	for i in Globals.colors:
		var node = ColorRect.new()
		node.color = i
		node.rect_min_size = Vector2(16, 16)
		$Scroll/VBox/ColorSelection/HBox.add_child(node)
	
	$Scroll/VBox/ColorSelection.value = Globals.colors.find(controller.color)
	
	# weapon selection
	var min_level = WeaponResource.Level.FLIMSY
	var max_level = WeaponResource.Level.EFFECTIVE
	
	for i in Globals.weapons:
		var weapon : WeaponResource = Globals.get_weapon(i)
		if weapon.level < min_level or weapon.level > max_level:
			continue
		
		var node = TextureRect.new()
		node.texture = Globals.get_weapon(i).icon
		node.rect_min_size = Vector2(16, 16)
		node.set_meta(\"id\", i)
		$Scroll/VBox/Weapon1Selection/HBox.add_child(node)
	
	controller.match_settings.weapon1 = \"sword\"

func _on_focus_changed(new_focus: Control):
	#$Scroll.set_v_scroll(new_focus.rect_position.y)
	pass



func get_directional_input_name(axis: int) -> String:
	if controller.keyboard:
		var settings = controller.button_settings
		return \"%s %s\" % [
			list_buttons(settings.left if axis == 0 else settings.up),
			list_buttons(settings.right if axis == 0 else settings.down)]
	else:
		var settings = controller.stick_settings
		match (settings.stick_x if axis == 0 else settings.stick_y):
			JOY_ANALOG_LX: return \"Left Stick L/R\"
			JOY_ANALOG_LY: return \"Left Stick U/D\"
			JOY_ANALOG_RX: return \"Right Stick L/R\"
			JOY_ANALOG_RY: return \"Right Stick U/D\"
			JOY_ANALOG_L2: return \"Left Trigger\"
			JOY_ANALOG_R2: return \"Right Trigger\"
			_ : return \"?\"

func list_buttons(array: Array):
	if array.empty():
		return \"None\"
	
	var text = get_button_name(array[0])
	
	for i in range(1, array.size()):
		text += \"/\" + get_button_name(array[i])
	
	return text

func get_button_name(index: int) -> String:
	if controller.keyboard:
		return OS.get_scancode_string(index)
	
	match index:
		JOY_XBOX_B: return \"B\"
		JOY_XBOX_A: return \"A\"
		JOY_XBOX_X: return \"X\"
		JOY_XBOX_Y: return \"Y\"
		JOY_L: return \"LB\"
		JOY_L2: return \"LT\"
		JOY_L3: return \"Left Stick\"
		JOY_R: return \"RB\"
		JOY_R2: return \"RT\"
		JOY_R3: return \"Right Stick\"
		_ : return \"?\"

func _on_ColorSelection_value_changed(value):
	controller.color = Globals.colors[value]
	$Scroll.update()

func _on_Weapon1Selection_value_changed(value):
	var container = $Scroll/VBox/Weapon1Selection/HBox
	var id = container.get_child(value).get_meta(\"id\")
	controller.match_settings.weapon1 = id



func _on_ReadyButton_pressed():
	emit_signal(\"player_ready\")




"

[sub_resource type="GDScript" id=2]
script/source = "extends ScrollContainer

func _ready():
	#get_v_scrollbar().rect_min_size.x = 2
	pass
"

[sub_resource type="GDScript" id=3]
script/source = "extends VBoxContainer

func _ready():
	
	for i in get_child_count():
		if i != 0:
			var path = get_child(i).get_path_to(get_child(i - 1))
			get_child(i).focus_neighbour_top = path
			
		if i != get_child_count() -1:
			var path = get_child(i).get_path_to(get_child(i + 1))
			get_child(i).focus_neighbour_bottom = path
"

[sub_resource type="StyleBoxFlat" id=4]
content_margin_left = 2.0
content_margin_right = 2.0
content_margin_top = 2.0
content_margin_bottom = 2.0
bg_color = Color( 0.262745, 0.262745, 0.278431, 1 )

[sub_resource type="StyleBoxFlat" id=5]
bg_color = Color( 1, 1, 1, 1 )
draw_center = false
border_width_left = 2
border_width_top = 2
border_width_right = 2
border_width_bottom = 2
border_color = Color( 1, 1, 1, 1 )
expand_margin_left = 2.0
expand_margin_right = 2.0
expand_margin_top = 2.0
expand_margin_bottom = 2.0

[sub_resource type="StyleBoxFlat" id=6]
bg_color = Color( 0.6, 0.6, 0.6, 0.501961 )

[sub_resource type="StyleBoxFlat" id=7]
bg_color = Color( 0.6, 0.6, 0.6, 0.25098 )

[node name="Control" type="Control"]
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
size_flags_horizontal = 3
script = SubResource( 1 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Panel" type="Panel" parent="."]
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
margin_left = -80.0
margin_top = -240.0
margin_right = 80.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Label" type="Label" parent="."]
visible = false
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
margin_left = -80.0
margin_top = -256.0
margin_right = 80.0
margin_bottom = -242.0
custom_colors/font_color_shadow = Color( 0, 0, 0, 1 )
custom_constants/shadow_as_outline = 1
text = "Player 1"
align = 1
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Scroll" type="ScrollContainer" parent="."]
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
margin_left = -76.0
margin_top = -236.0
margin_right = 76.0
margin_bottom = -4.0
scroll_horizontal_enabled = false
script = SubResource( 2 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="VBox" type="VBoxContainer" parent="Scroll"]
margin_right = 152.0
margin_bottom = 98.0
size_flags_horizontal = 3
custom_constants/separation = 2
script = SubResource( 3 )

[node name="Controls" type="Label" parent="Scroll/VBox"]
margin_right = 152.0
margin_bottom = 14.0

[node name="ColorSelection" type="Control" parent="Scroll/VBox"]
margin_top = 16.0
margin_right = 152.0
margin_bottom = 40.0
rect_min_size = Vector2( 0, 24 )
script = ExtResource( 1 )
wrap_around = true
display_text = 0
bg_stylebox = SubResource( 4 )
selected_stylebox = SubResource( 5 )

[node name="HBox" type="HBoxContainer" parent="Scroll/VBox/ColorSelection"]
anchor_right = 1.0
margin_left = 4.0
margin_top = 4.0
margin_right = -4.0
margin_bottom = 20.0
custom_constants/separation = 4
alignment = 1
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Weapon1Selection" type="Control" parent="Scroll/VBox"]
margin_top = 42.0
margin_right = 152.0
margin_bottom = 82.0
rect_min_size = Vector2( 0, 40 )
focus_neighbour_top = NodePath("../ReadyButton")
script = ExtResource( 1 )
wrap_around = true
display_text = 0
bg_stylebox = SubResource( 4 )
selected_stylebox = SubResource( 5 )

[node name="HBox" type="HBoxContainer" parent="Scroll/VBox/Weapon1Selection"]
anchor_right = 1.0
margin_left = 4.0
margin_top = 4.0
margin_right = -4.0
margin_bottom = 20.0
custom_constants/separation = 4
alignment = 1
__meta__ = {
"_edit_use_anchors_": false
}

[node name="ReadyButton" type="Button" parent="Scroll/VBox"]
margin_top = 84.0
margin_right = 152.0
margin_bottom = 98.0
focus_mode = 0
custom_styles/pressed = SubResource( 6 )
custom_styles/normal = SubResource( 7 )
text = "Ready"
__meta__ = {
"_edit_use_anchors_": false
}
[connection signal="value_changed" from="Scroll/VBox/ColorSelection" to="." method="_on_ColorSelection_value_changed"]
[connection signal="value_changed" from="Scroll/VBox/Weapon1Selection" to="." method="_on_Weapon1Selection_value_changed"]
[connection signal="pressed" from="Scroll/VBox/ReadyButton" to="." method="_on_ReadyButton_pressed"]
